"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[4264],{4264:(x,h,m)=>{m.r(h),m.d(h,{DescontoPageModule:()=>X});var f=m(316),C=m(496),l=m(957),b=m(1379),v=m(9204),y=m(6443),o=m(7404),P=m(5841),I=m(8278);let $=(()=>{var n;class a{constructor(t){this.dbService=t}addDescontoCombustivel(t,e,r,d,c,u,p,D,i,g){var S=this;return(0,v.A)(function*(){return yield S.dbService.addDescontoCombustivel(t,e,r,d,c,u,p,D,i,g)})()}updateDescontoCombustivel(t,e,r,d,c,u,p,D,i,g,S){var M=this;return(0,v.A)(function*(){return yield M.dbService.updateDescontoCombustivel(t,e,r,d,c,u,p,D,i,g,S)})()}getDescontosCombustiveisByDescontoId(t){var e=this;return(0,v.A)(function*(){return yield e.dbService.descontoscombustiveis.where("iddesconto").equals(t).toArray()})()}deleteDescontosCombustiveis(t){var e=this;return(0,v.A)(function*(){return yield e.dbService.deleteDescontosCombustiveis(t)})()}}return(n=a).\u0275fac=function(t){return new(t||n)(o.KVO(I.B))},n.\u0275prov=o.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}),a})(),T=(()=>{var n;class a{constructor(t){this.dbService=t}addDescontotipopagamentoService(t,e,r){var d=this;return(0,v.A)(function*(){return yield d.dbService.addDescontoTiposPagamento(t,e,r)})()}updateDescontotipopagamentoService(t,e,r,d){var c=this;return(0,v.A)(function*(){return yield c.dbService.updateDescontoTiposPagamento(t,e,r,d)})()}getDescontoTiposPagamentoByDescontoId(t){var e=this;return(0,v.A)(function*(){return yield e.dbService.getDescontoTiposPagamentoByDescontoId(t)})()}deleteDescontoTiposPagamento(t){var e=this;return(0,v.A)(function*(){return yield e.dbService.deleteDescontoTiposPagamento(t)})()}}return(n=a).\u0275fac=function(t){return new(t||n)(o.KVO(I.B))},n.\u0275prov=o.jDH({token:n,factory:n.\u0275fac,providedIn:"root"}),a})();var F=m(9153),R=m(4747),j=m(7127),A=m(8685);const E=()=>({color:"red"});function _(n,a){if(1&n&&(o.j41(0,"span"),o.EFF(1),o.nI1(2,"number"),o.k0s()),2&n){const s=o.XpG().$implicit,t=o.XpG();o.R7$(),o.LHq(" Desconto: ",s.id," - R$",o.i5U(2,4,s.totaldesconto,"1.2-2")," - ",t.formatDateTime(s.datahora)," - Atendente: ",s.nomeatendente," ")}}function B(n,a){if(1&n&&(o.j41(0,"span",12),o.EFF(1),o.nI1(2,"number"),o.k0s()),2&n){const s=o.XpG().$implicit,t=o.XpG();o.Y8G("ngStyle",o.lJ4(8,E)),o.R7$(),o.LHq(" Desconto Cancelado: ",s.id," - R$",o.i5U(2,5,s.totaldesconto,"1.2-2")," - ",t.formatDateTime(s.datahora)," - Atendente: ",s.nomeatendente," ")}}function G(n,a){if(1&n&&(o.j41(0,"ion-item")(1,"ion-label")(2,"p"),o.EFF(3),o.k0s(),o.j41(4,"p"),o.EFF(5),o.k0s(),o.j41(6,"p"),o.EFF(7),o.k0s(),o.j41(8,"p"),o.EFF(9),o.k0s(),o.j41(10,"p"),o.EFF(11),o.nI1(12,"number"),o.k0s(),o.j41(13,"p"),o.EFF(14),o.nI1(15,"number"),o.k0s(),o.j41(16,"p"),o.EFF(17),o.nI1(18,"number"),o.k0s(),o.j41(19,"p",13),o.EFF(20),o.nI1(21,"number"),o.k0s()()()),2&n){const s=a.$implicit;o.R7$(3),o.SpI("Bomba: ",s.idbomba,""),o.R7$(2),o.SpI("Bico: ",s.idbico,""),o.R7$(2),o.SpI("Combust\xedvel: ",s.nome,""),o.R7$(2),o.SpI("Pre\xe7o: ",s.preco,""),o.R7$(2),o.SpI("Total de litros abastecidos: ",o.i5U(12,8,s.totallitros,"1.2-2"),""),o.R7$(3),o.SpI("Total sem desconto: R$",o.i5U(15,11,s.totalprecocombustivel,"1.2-2"),""),o.R7$(3),o.SpI("Total de desconto recebido: R$",o.i5U(18,14,s.totaldescontorecebidocombustivel,"1.2-2"),""),o.R7$(3),o.SpI("Total com desconto: R$",o.i5U(21,17,s.totaldescontocombustivel,"1.2-2"),"")}}function k(n,a){if(1&n){const s=o.RV6();o.j41(0,"ion-accordion")(1,"ion-item",6)(2,"ion-label"),o.DNE(3,_,3,7,"span",7)(4,B,3,9,"span",8),o.k0s(),o.j41(5,"ion-buttons",9)(6,"ion-button",4),o.bIt("click",function(){const e=o.eBV(s).$implicit,r=o.XpG();return o.Njj(r.viewDesconto(e))}),o.EFF(7,"Visualizar"),o.k0s(),o.j41(8,"ion-button",10),o.bIt("click",function(){const e=o.eBV(s).$implicit,r=o.XpG();return o.Njj(r.cancelaDesconto(e.id))}),o.EFF(9,"Cancelar"),o.k0s()()(),o.j41(10,"ion-list",11),o.DNE(11,G,22,20,"ion-item",2),o.k0s()()}if(2&n){const s=a.$implicit,t=o.XpG();o.R7$(3),o.Y8G("ngIf",!(null!=s&&s.cancelado)),o.R7$(),o.Y8G("ngIf",null==s?null:s.cancelado),o.R7$(7),o.Y8G("ngForOf",t.descontosCombustiveis[s.id])}}const N=[{path:"",component:(()=>{var n;class a{constructor(t,e,r,d,c,u,p,D,i){this.descontoService=t,this.descontocombustiveisService=e,this.descontotipopagamentoService=r,this.alertController=d,this.descontoDataService=c,this.router=u,this.utilService=p,this.gerarDadosRetornoIntegracaoService=D,this.pedidoService=i,this.descontos=[],this.descontosCombustiveis={},this.descontoTiposPagamento={}}ngOnInit(){}ionViewWillEnter(){this.loadDescontos()}loadDescontos(){var t=this;return(0,v.A)(function*(){try{t.descontos=[],t.descontosCombustiveis={},t.descontos=yield t.descontoService.getAllDescontos(),t.descontos.sort((e,r)=>new Date(r.datahora).getTime()-new Date(e.datahora).getTime());for(let e of t.descontos)t.descontosCombustiveis[e.id]=yield t.descontocombustiveisService.getDescontosCombustiveisByDescontoId(e.id),t.descontoTiposPagamento[e.id]=yield t.descontotipopagamentoService.getDescontoTiposPagamentoByDescontoId(e.id)}catch(e){console.error("Erro ao carregar descontos",e),yield t.utilService.showAlert("Erro","N\xe3o foi poss\xedvel carregar os descontos.")}})()}cancelaDesconto(t){var e=this;return(0,v.A)(function*(){const r=yield e.descontoService.getDescontoById(t);var u,c;r&&null!=r&&r.cancelado?yield e.utilService.showAlert("Erro","O Desconto j\xe1 est\xe1 cancelado."):!r||null!=r&&r.confirmado?yield(yield e.alertController.create({header:"Confirmar o cancelamento",message:"Deseja realmente cancelar este desconto?",buttons:[{text:"N\xe3o",role:"cancel"},{text:"Sim",handler:(c=(0,v.A)(function*(){yield e.cancelaDescontoAPI(t),yield e.descontoService.cancelaDesconto(t),yield e.gerarDadosRetornoIntegracao(t),e.loadDescontos()}),function(){return c.apply(this,arguments)})}]})).present():yield(yield e.alertController.create({header:"Confirmar a exclus\xe3o",message:"O Desconto ainda n\xe3o foi gerado para ser cancelado. Deseja excluir este desconto?",buttons:[{text:"N\xe3o",role:"cancel"},{text:"Sim",handler:(u=(0,v.A)(function*(){yield e.descontoService.deleteDesconto(t),e.loadDescontos()}),function(){return u.apply(this,arguments)})}]})).present()})()}cancelaDescontoAPI(t){var e=this;return(0,v.A)(function*(){const r=yield e.descontoService.getDescontoById(t),d={pedidoId:r.idpedidodidiglobal,Recibo:r.numerorecibo.toString()};try{const c=yield e.pedidoService.cancelarPedido(d);return console.log(`${JSON.stringify(d)}`),console.log(`TraceID CancelaDesconto: ${c.trace_Id}`),console.log(`statusCode: ${c.statusCode}`),(c.statusCode=200)?(r.cancelado=!0,!0):(yield e.utilService.showAlert("Erro",`N\xe3o foi poss\xedvel cancelar o desconto: ${c.errmsg}`),!1)}catch(c){console.error("Erro ao cancelar desconto:",c);let u="Erro desconhecido";return c instanceof y.yz&&(c.error&&"object"==typeof c.error&&"errmsg"in c.error?u=c.error.errmsg:c.message&&(u=c.message)),yield e.utilService.showAlert("Erro",`N\xe3o foi poss\xedvel cancelar o desconto: ${u}`),!1}})()}viewDesconto(t){var e=this;return(0,v.A)(function*(){e.descontoDataService.setDesconto(t),e.descontoDataService.clearCurrentDescontoCombustivel(),e.descontoDataService.clearCurrentDescontoTiposPagamento();const r=yield e.descontocombustiveisService.getDescontosCombustiveisByDescontoId(t.id);e.descontoDataService.setDescontosCombustiveis(r);const d=yield e.descontotipopagamentoService.getDescontoTiposPagamentoByDescontoId(t.id);e.descontoDataService.setDescontoTiposPagamento(d),e.router.navigate(["/caddesconto"])})()}redirectGerarDesconto(){this.descontoDataService.clear(),this.router.navigate(["/caddesconto"])}formatDateTime(t){if(!t)return"";const e=new Date(t);return`${String(e.getDate()).padStart(2,"0")}/${String(e.getMonth()+1).padStart(2,"0")}/${e.getFullYear()} - ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}`}gerarDadosRetornoIntegracao(t){var e=this;return(0,v.A)(function*(){const r=[],d=[];e.SomaTotalDescontoRecebido=0;const c=yield e.descontoService.getDescontoById(t),u=yield e.descontocombustiveisService.getDescontosCombustiveisByDescontoId(t),p=yield e.descontotipopagamentoService.getDescontoTiposPagamentoByDescontoId(t);for(const i of u){const g={id:i.id,idDesconto:i.iddesconto,idCombustivel:i.idcombustivel,idBomba:i.idbomba,idBico:i.idbico,nome:i.nome,preco:i.preco,totalLitros:i.totallitros,totalPrecoCombustivel:i.totalprecocombustivel,totalDescontoCombustivel:i.totaldescontocombustivel,totalDescontoRecebidoCombustivel:i.totaldescontorecebidocombustivel};e.SomaTotalDescontoRecebido+=i.totaldescontorecebidocombustivel,r.push(g)}for(const i of p)d.push({id:i.id,idDesconto:i.iddesconto,tipo:i.tipopagamento,valor:i.valorpago});const D={id:c.id,descontoPagamento:d,NomeAtendente:c.nomeatendente,totalPreco:c.totalpreco,totalDesconto:c.totaldesconto,dataHora:c.datahora,recibo:c.numerorecibo,idPedidoDidiGlobal:c.idpedidodidiglobal,codigoDesconto:c.codigodesconto,confirmado:c.confirmado,totalDescontoRecebido:e.SomaTotalDescontoRecebido,cancelado:c.cancelado,descontoCombustivel:r};try{const i=yield e.gerarDadosRetornoIntegracaoService.gerarDadosRetorno(D);return console.log(`${JSON.stringify(D)}`),!!i.arquivoGerado||(yield e.utilService.showAlert("Erro","N\xe3o foi poss\xedvel gerar o arquivo de retorno JSON"),!1)}catch(i){console.error("Erro ao gerar retorno:",i);let g="Erro desconhecido";return i instanceof y.yz&&(i.error&&"object"==typeof i.error&&"errmsg"in i.error?g=i.error.errmsg:i.message&&(g=i.message)),yield e.utilService.showAlert("Erro",`N\xe3o foi poss\xedvel gerar o arquivo de retorno JSON: ${g}`),!1}})()}}return(n=a).\u0275fac=function(t){return new(t||n)(o.rXU(P.P),o.rXU($),o.rXU(T),o.rXU(l.hG),o.rXU(F.n),o.rXU(b.Ix),o.rXU(R.a),o.rXU(j.Q),o.rXU(A.H))},n.\u0275cmp=o.VBU({type:n,selectors:[["app-desconto"]],decls:12,vars:2,consts:[[3,"translucent"],["slot","start"],[4,"ngFor","ngForOf"],["vertical","bottom","horizontal","end","slot","fixed"],[3,"click"],["name","add"],["slot","header"],[4,"ngIf"],[3,"ngStyle",4,"ngIf"],["slot","end"],["color","danger",3,"click"],["slot","content"],[3,"ngStyle"],["color","danger"]],template:function(t,e){1&t&&(o.j41(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-buttons",1),o.nrm(3,"ion-menu-button"),o.k0s(),o.j41(4,"ion-title"),o.EFF(5,"Lista de Descontos"),o.k0s()()(),o.j41(6,"ion-content")(7,"ion-accordion-group"),o.DNE(8,k,12,3,"ion-accordion",2),o.k0s(),o.j41(9,"ion-fab",3)(10,"ion-fab-button",4),o.bIt("click",function(){return e.redirectGerarDesconto()}),o.nrm(11,"ion-icon",5),o.k0s()()()),2&t&&(o.Y8G("translucent",!0),o.R7$(8),o.Y8G("ngForOf",e.descontos))},dependencies:[f.Sq,f.bT,f.B3,l.xk,l.YH,l.Jm,l.QW,l.W9,l.Q8,l.YW,l.eU,l.iq,l.uz,l.he,l.nf,l.MC,l.BC,l.ai,f.QX]}),a})()}];let U=(()=>{var n;class a{}return(n=a).\u0275fac=function(t){return new(t||n)},n.\u0275mod=o.$C({type:n}),n.\u0275inj=o.G2t({imports:[b.iI.forChild(N),b.iI]}),a})(),X=(()=>{var n;class a{}return(n=a).\u0275fac=function(t){return new(t||n)},n.\u0275mod=o.$C({type:n}),n.\u0275inj=o.G2t({imports:[f.MD,C.YN,l.bv,U]}),a})()}}]);
//# sourceMappingURL=4264.0a699b0a458ba3f6.js.map